(function(d,c){var a=function(f,e){this.obj=f;this.opts=e;this.container=this.createContainer();this.placeholder=$(".placeholder",this.container)[0];this.listWrap=$(".filelist",this.container)[0];this.status=$(".status",this.container)[0];this.file=$("input",this.container);this.progress=$(".status .progress",this.container)[0];this.info=$(".status .info",this.container)[0];this.files=[];this.index=0;this.bindEvent()};a.prototype={bindEvent:function(){var e=this;this.file.each(function(){var f=this;e.addEvent(this,"change",function(){e.selectFile(f.files)})});this.addEvent(this.container,"click",function(h){var g=h.target||d.event.srcElement;var i=$.attr(g,"data-role");var f=e.getIndex(g.parentNode.parentNode||c.body);switch(i){case"upload":e.uploadFile();break;case"delete":e.deleteFile(f);break;case"rotateLeft":e.rotate(f,-1);break;case"rotateRight":e.rotate(f,1);break;default:break}});this.addEvent(c,"dragleave",function(f){f.preventDefault()});this.addEvent(c,"drop",function(f){f.preventDefault()});this.addEvent(c,"dragenter",function(f){f.preventDefault()});this.addEvent(c,"dragover",function(f){f.preventDefault()});this.addEvent(this.container,"drop",function(f){f.preventDefault();e.selectFile(f.dataTransfer.files)})},addEvent:function(g,f,e){if(g.addEventListener){g.addEventListener(f,e,false)}else{if(g.attachEvent){g.attachEvent("on"+f,e)}else{g["on"+f]=e}}},getIndex:function(j){var g=0;var f=this.getChild(j.parentNode);for(var h=0,e=f.length;h<e;h++){if(f[h]===j){g=h;break}}return g},getChild:function(g){var h=g.childNodes;var j=[];for(var f=0,e=h.length;f<e;f++){var k=h[f];if(k.nodeName!=="#text"||/\s/.test(k.nodeValue)){j.push(k)}}j.each=function(i){$.each.call(j,i)};return j},changeArray:function(h){var f=[];for(var g=0,e=h.length;g<e;g++){f.push(h[g])}return f},changeInfo:function(){this.info.innerHTML="选中"+this.files.length+"张图片"},changePanel:function(e,f){this.placeholder.style.display=e;this.listWrap.style.display=f;this.status.style.display=f},checkType:function(j){var h=this.opts.fileType.split(";");var k={};for(var g=0,e=h.length;g<e;g++){var f=h[g].split(".")[1];if(typeof f!=="undefined"){k[f]=true}}return k[j.split("/")[1]]},createContainer:function(){var h='<div class="placeholder"><div class="wrap"><div class="add"><label>添加图片</label><input type="file" multiple="multiple" /></div><p class="tips">最多可添加'+this.opts.maxCount+"张图片</p></div></div>";var g='<ul class="filelist"></ul>';var f='<div class="status"><div class="btns"><div class="add"><label>继续添加</label><input type="file" multiple="multiple" /></div></div><div class="progress"><span class="text">0%</span><span class="percentage"></span></div><div class="info"></div></div>';var e=c.createElement("div");e.className="x-multifile-wrap";e.innerHTML=h+g+f;e.style.cssText="width:"+this.opts.width+"px;height:"+this.opts.height+"px;";this.obj.appendChild(e);return e},createFile:function(j,i,h,k){var g='<p class="img" ><img name="'+j+'" src="'+i+'" style="width:'+this.opts.tnWidth+"px; height:"+this.opts.tnHeight+'px"/></p>';var l='<p class="title"><a data-role="delete"><i class="fa fa-times"></i> 移除图片</a></p>';var f='<span class="result"></span>';var e=c.createElement("li");e.innerHTML=g+l+f;e.style.cssText="width:"+(this.opts.tnWidth+6)+"px;height"+(this.opts.tnHeight+4)+"px;";this.listWrap.appendChild(e);this.fillList=$(".filelist li",this.container)},deleteFile:function(e){var f=this.files[e].name;$('.filelist li:eq("'+e+'")',this.container).remove();this.files.splice(e,1);if(this.files.length===0){this.changePanel("block","none")}this.changeInfo();this.opts.deleteFileCallback&&this.opts.deleteFileCallback(f)},rotate:function(f,g){var e=$(".img",this.fillList[f])[0];var h=$.data(e,"angle")||0;h+=g*90;e.style.transform="rotate("+h+"deg)";e.style.webkitTransform="rotate("+h+"deg)";$.data(e,"angle",h)},selectFile:function(g){g=this.changeArray(g);var k=g.length;var f=this.files.length;var e=this.opts.maxCount;if(f+k>e){g.splice(e-f-k,f+k-e)}for(var j=0;j<g.length;j++){var h=g[j];if(this.checkType(h.type)){this.files.push(h);(function(i,l){$.when(l.tryReadAndCompressImage(i)).done(function(m){l.createFile(i.name,m);l.uploadBase64ToServer(i.name,m)}).fail(function(m){l.uploadImageFileToServer(i)})})(h,this)}}if(this.files.length>0){this.changePanel("none","block");this.changeInfo();this.opts.selectFileCallback&&this.opts.selectFileCallback()}},tryReadAndCompressImage:function(h){var i=this.opts.maxImgWidth;var g=this.opts.maxImgHeight;var f=$.Deferred();if(!FileReader||typeof FileReader=="undefined"){f.reject("not support FileReader")}else{var e=new FileReader();e.readAsDataURL(h);e.onload=function(k){var j=k.target.result;try{var m=new Image();m.src=j;m.onload=function(){var q=document.getElementById("theCanvas");if(!q){f.reject("Can not initialize Canvas: "+q)}var p=false;var r=m.width;var n=m.height;if(r>n){if(r>i){n=Math.round(n*=i/r);r=i;p=true}}else{if(n>g){r=Math.round(r*=g/n);n=g;p=true}}if(p){q.width=r;q.height=n;var o=q.getContext("2d");o.drawImage(m,0,0,r,n);var s=q.toDataURL("image/jpeg",0.7);if(s.length<j.length){j=s}else{s=null}}f.resolve(j)}}catch(l){f.resolve(j)}};e.onprocess=function(){$("#upload-image-loading").removeClass("hide")};e.onerror=function(){f.reject("reader error")}}return f.promise()},uploadBase64ToServer:function(g,f){document.uploadingTasks++;var e=encodeURIComponent(f);$.post(this.opts.uploadUrl+"/base64",{fileName:g,imageData:e}).done(function(h){f=null;if(h&&h.link){document.imageUrls[g]=h.link}else{if(h&&h.errors){var i=h.errors.join("<br/>");$.showWarning(i)}}document.uploadingTasks--}).fail(function(h){document.uploadingTasks--;$.showWarning("上传图片失败，图片大小不能超过5M，请尝试更换其他图片重试！")})},uploadImageFileToServer:function(e){document.uploadingTasks++;var g=this;data=new FormData($("#imageForm")[0]);data.append("image",e);var f=this.opts.uploadUrl;$.ajax({url:f,data:data,cache:false,contentType:false,processData:false,type:"POST"}).done(function(h){if(h&&h.link){document.imageUrls[e.name]=h.link;var j=h.link;if(document.contextPath=="/"){j=document.contextPath+h.link}else{j=document.contextPath+"/"+h.link}g.createFile(e.name,j)}else{if(h&&h.errors){var i=h.errors.join("<br/>");$.showWarning(i)}}document.uploadingTasks--}).fail(function(h){document.uploadingTasks--;$.showWarning("上传图片失败，图片大小不能超过5M，请尝试更换其他图片重试！")})},uploadComplete:function(i){var g=this.files[this.index];if(g.packet&&g.breakpoint<g.packet.length-1){g.breakpoint++;this.uploadFile()}else{var f=$.query(".result",this.fillList[this.index])[0];f.style.display="inline-block";f.innerHTML="&#xf00b2;";if(this.index===this.files.length-1){this.opts.allCompleteCallback&&this.opts.allCompleteCallback(i);this.progress.style.display="none";this.info.innerHTML="共"+this.files.length+"张图片，已上传"+(this.index+1)+"张"}else{this.index++;this.uploadFile();this.info.innerHTML="正在上传"+(this.index+1)+"/"+this.files.length+"张图片"}var h=Math.floor((this.index/this.files.length)*100)+"%";this.progress.innerHTML='<span class="text">'+h+'</span><span class="percentage" style="width:'+h+'"></span>';this.opts.uploadCompleteCallback&&this.opts.uploadCompleteCallback(i)}},uploadFailed:function(f){this.opts.uploadErrorCallback&&this.opts.uploadErrorCallback(f)},uploadFile:function(){var h=new XMLHttpRequest();var j=this;h.upload.addEventListener("progress",function(k){j.uploadProgress(k)},false);h.addEventListener("load",function(k){j.uploadComplete(k)},false);h.addEventListener("error",function(k){j.uploadFailed(k)},false);h.open("post",this.opts.uploadUrl,true);var g=new FormData();var f=this.files[this.index];var i=this.opts.fieldName;if(f.packet){g.append("breakpoint",f.breakpoint);g.append("len",f.packet.length);g.append("fileName",f.name);g.append("tag",f.tag);g.append(i,f.packet[f.breakpoint])}else{g.append(i,f)}for(var e in this.opts.extraData){g.append(e,this.opts.extraData[e])}h.send(g);this.progress.style.display="inline-block"},uploadProgress:function(i){if(i.lengthComputable){var g=$(".filelist .progress span",this.container);var f=Math.round(i.loaded*100/i.total);var h=this.files[this.index];if(h.packet){f=Math.round((h.breakpoint*i.total+i.loaded)*100/(h.packet.length*i.total))}g[this.index].style.width=f+"%"}}};var b=[];$.multiFile=function(f){f=$.extend($.multiFile.defualts,f);var h=$(f.selector)[0];h=$.isArray(h)?h:[h];for(var g=0,e=h.length;g<e;g++){b.push(new a(h[g],f))}};$.multiFile.defualts={selector:"#images-wrapper",height:170,tnWidth:80,tnHeight:60,maxImgWidth:640,maxImgHeight:1024,maxCount:6,uploadUrl:"/mblog/saveimage",fieldName:"file",fileType:"*.gif;*.png;*.jpg;*.jpeg;",selectFileCallback:function(){},deleteFileCallback:function(e){delete document.imageUrls[e]},exceedFileCallback:function(){},startUploadCallback:function(){},uploadCompleteCallback:function(){},uploadErrorCallback:function(){},allCompleteCallback:function(){}}})(window,document);